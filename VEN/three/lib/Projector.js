THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var Y,Z,i,$,_,ee,re,te,ne,ie,oe,ae=[],se=0,le=[],r=0,t=[],n=0,o=[],a=0,s=[],l=0,ce={objects:[],lights:[],elements:[]},pe=new THREE.Vector3,Ee=new THREE.Vector4,f=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),m=new THREE.Box3,v=new Array(3),ue=(new Array(4),new THREE.Matrix4),de=new THREE.Matrix4,he=new THREE.Matrix4,fe=new THREE.Matrix3,me=new THREE.Frustum,ve=new THREE.Vector4,Re=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var xe=new function(){var l=[],c=[],p=null,E=null,u=new THREE.Matrix3;function n(e){var r=e.position,t=e.positionWorld,n=e.positionScreen;t.copy(r).applyMatrix4(oe),n.copy(t).applyMatrix4(de);var i=1/n.w;n.x*=i,n.y*=i,n.z*=i,e.visible=-1<=n.x&&n.x<=1&&-1<=n.y&&n.y<=1&&-1<=n.z&&n.z<=1}function d(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(v[0]=e.positionScreen,v[1]=r.positionScreen,v[2]=t.positionScreen,f.intersectsBox(m.setFromPoints(v)))}function h(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){E=(p=e).material,u.getNormalMatrix(p.matrixWorld),l.length=0,c.length=0},projectVertex:n,checkTriangleVisibility:d,checkBackfaceCulling:h,pushVertex:function(e,r,t){(i=ye()).position.set(e,r,t),n(i)},pushNormal:function(e,r,t){l.push(e,r,t)},pushUv:function(e,r){c.push(e,r)},pushLine:function(e,r){var t=le[e],n=le[r];(re=He()).id=p.id,re.v1.copy(t),re.v2.copy(n),re.z=(t.positionScreen.z+n.positionScreen.z)/2,re.renderOrder=p.renderOrder,re.material=p.material,ce.elements.push(re)},pushTriangle:function(e,r,t){var n=le[e],i=le[r],o=le[t];if(!1!==d(n,i,o)&&(E.side===THREE.DoubleSide||!0===h(n,i,o))){(_=Te()).id=p.id,_.v1.copy(n),_.v2.copy(i),_.v3.copy(o),_.z=(n.positionScreen.z+i.positionScreen.z+o.positionScreen.z)/3,_.renderOrder=p.renderOrder,_.normalModel.fromArray(l,3*e),_.normalModel.applyMatrix3(u).normalize();for(var a=0;a<3;a++){var s=_.vertexNormalsModel[a];s.fromArray(l,3*arguments[a]),s.applyMatrix3(u).normalize(),_.uvs[a].fromArray(c,2*arguments[a])}_.vertexNormalsLength=3,_.material=p.material,ce.elements.push(_)}}}};function ye(){if($!==r)return le[$++];var e=new THREE.RenderableVertex;return le.push(e),r++,$++,e}function Te(){if(ee!==n)return t[ee++];var e=new THREE.RenderableFace;return t.push(e),n++,ee++,e}function He(){if(te!==a)return o[te++];var e=new THREE.RenderableLine;return o.push(e),a++,te++,e}function we(){if(ie!==l)return s[ie++];var e=new THREE.RenderableSprite;return s.push(e),l++,ie++,e}function ge(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function be(e,r){var t=0,n=1,i=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return 0<=i&&0<=o&&0<=a&&0<=s||!(i<0&&o<0||a<0&&s<0)&&(i<0?t=Math.max(t,i/(i-o)):o<0&&(n=Math.min(n,i/(i-o))),a<0?t=Math.max(t,a/(a-s)):s<0&&(n=Math.min(n,a/(a-s))),!(n<t)&&(e.lerp(r,t),r.lerp(e,1-n),!0))}this.projectScene=function(e,r,t,n){function i(e){(Y=function(){if(Z!==se)return ae[Z++];var e=new THREE.RenderableObject;return ae.push(e),se++,Z++,e}()).id=e.id,Y.object=e,pe.setFromMatrixPosition(e.matrixWorld),pe.applyMatrix4(de),Y.z=pe.z,Y.renderOrder=e.renderOrder,ce.objects.push(Y)}ie=te=ee=0,!(ce.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),ue.copy(r.matrixWorldInverse.getInverse(r.matrixWorld)),de.multiplyMatrices(r.projectionMatrix,ue),me.setFromMatrix(de),Z=0,ce.objects.length=0,ce.lights.length=0,e.traverseVisible(function(e){if(e instanceof THREE.Light)ce.lights.push(e);else if(e instanceof THREE.Mesh||e instanceof THREE.Line){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===me.intersectsObject(e))return;i(e)}else if(e instanceof THREE.Sprite){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===me.intersectsSprite(e))return;i(e)}}),!0===t&&ce.objects.sort(ge);for(var o=0,a=ce.objects.length;o<a;o++){var s=ce.objects[o].object,l=s.geometry;if(xe.setObject(s),oe=s.matrixWorld,$=0,s instanceof THREE.Mesh){if(l instanceof THREE.BufferGeometry){var c=l.attributes,p=l.groups;if(void 0===c.position)continue;for(var E=0,u=(K=c.position.array).length;E<u;E+=3)xe.pushVertex(K[E],K[E+1],K[E+2]);if(void 0!==c.normal){var d=c.normal.array;for(E=0,u=d.length;E<u;E+=3)xe.pushNormal(d[E],d[E+1],d[E+2])}if(void 0!==c.uv){var h=c.uv.array;for(E=0,u=h.length;E<u;E+=2)xe.pushUv(h[E],h[E+1])}if(null!==l.index){var f=l.index.array;if(0<p.length)for(var m=0;m<p.length;m++){var v=p[m];for(E=v.start,u=v.start+v.count;E<u;E+=3)xe.pushTriangle(f[E],f[E+1],f[E+2])}else for(E=0,u=f.length;E<u;E+=3)xe.pushTriangle(f[E],f[E+1],f[E+2])}else for(E=0,u=K.length/3;E<u;E+=3)xe.pushTriangle(E,E+1,E+2)}else if(l instanceof THREE.Geometry){var R=l.vertices,x=l.faces,y=l.faceVertexUvs[0];fe.getNormalMatrix(oe);for(var T=s.material,H=T instanceof THREE.MultiMaterial,w=!0==H?s.material:null,g=0,b=R.length;g<b;g++){var M=R[g];if(pe.copy(M),!0===T.morphTargets)for(var S=l.morphTargets,z=s.morphTargetInfluences,V=0,j=S.length;V<j;V++){var O=z[V];if(0!==O){var C=S[V].vertices[g];pe.x+=(C.x-M.x)*O,pe.y+=(C.y-M.y)*O,pe.z+=(C.z-M.z)*O}}xe.pushVertex(pe.x,pe.y,pe.z)}for(var L=0,k=x.length;L<k;L++){var N=x[L];if(void 0!==(T=!0==H?w.materials[N.materialIndex]:s.material)){var W=T.side,B=le[N.a],F=le[N.b],P=le[N.c];if(!1!==xe.checkTriangleVisibility(B,F,P)){var A=xe.checkBackfaceCulling(B,F,P);if(W!==THREE.DoubleSide){if(W===THREE.FrontSide&&!1===A)continue;if(W===THREE.BackSide&&!0===A)continue}(_=Te()).id=s.id,_.v1.copy(B),_.v2.copy(F),_.v3.copy(P),_.normalModel.copy(N.normal),!1!==A||W!==THREE.BackSide&&W!==THREE.DoubleSide||_.normalModel.negate(),_.normalModel.applyMatrix3(fe).normalize();for(var D=N.vertexNormals,G=0,I=Math.min(D.length,3);G<I;G++){var U=_.vertexNormalsModel[G];U.copy(D[G]),!1!==A||W!==THREE.BackSide&&W!==THREE.DoubleSide||U.negate(),U.applyMatrix3(fe).normalize()}_.vertexNormalsLength=D.length;var q=y[L];if(void 0!==q)for(var J=0;J<3;J++)_.uvs[J].copy(q[J]);_.color=N.color,_.material=T,_.z=(B.positionScreen.z+F.positionScreen.z+P.positionScreen.z)/3,_.renderOrder=s.renderOrder,ce.elements.push(_)}}}}}else if(s instanceof THREE.Line){if(l instanceof THREE.BufferGeometry){if(void 0!==(c=l.attributes).position){var K;for(E=0,u=(K=c.position.array).length;E<u;E+=3)xe.pushVertex(K[E],K[E+1],K[E+2]);if(null!==l.index)for(E=0,u=(f=l.index.array).length;E<u;E+=2)xe.pushLine(f[E],f[E+1]);else{var Q=s instanceof THREE.LineSegments?2:1;for(E=0,u=K.length/3-1;E<u;E+=Q)xe.pushLine(E,E+1)}}}else if(l instanceof THREE.Geometry){if(he.multiplyMatrices(de,oe),0===(R=s.geometry.vertices).length)continue;(B=ye()).positionScreen.copy(R[0]).applyMatrix4(he);for(Q=s instanceof THREE.LineSegments?2:1,g=1,b=R.length;g<b;g++)(B=ye()).positionScreen.copy(R[g]).applyMatrix4(he),0<(g+1)%Q||(F=le[$-2],ve.copy(B.positionScreen),Re.copy(F.positionScreen),!0===be(ve,Re)&&(ve.multiplyScalar(1/ve.w),Re.multiplyScalar(1/Re.w),(re=He()).id=s.id,re.v1.positionScreen.copy(ve),re.v2.positionScreen.copy(Re),re.z=Math.max(ve.z,Re.z),re.renderOrder=s.renderOrder,re.material=s.material,s.material.vertexColors===THREE.VertexColors&&(re.vertexColors[0].copy(s.geometry.colors[g]),re.vertexColors[1].copy(s.geometry.colors[g-1])),ce.elements.push(re)))}}else if(s instanceof THREE.Sprite){Ee.set(oe.elements[12],oe.elements[13],oe.elements[14],1),Ee.applyMatrix4(de);var X=1/Ee.w;Ee.z*=X,-1<=Ee.z&&Ee.z<=1&&((ne=we()).id=s.id,ne.x=Ee.x*X,ne.y=Ee.y*X,ne.z=Ee.z,ne.renderOrder=s.renderOrder,ne.object=s,ne.rotation=s.rotation,ne.scale.x=s.scale.x*Math.abs(ne.x-(Ee.x+r.projectionMatrix.elements[0])/(Ee.w+r.projectionMatrix.elements[12])),ne.scale.y=s.scale.y*Math.abs(ne.y-(Ee.y+r.projectionMatrix.elements[5])/(Ee.w+r.projectionMatrix.elements[13])),ne.material=s.material,ce.elements.push(ne))}}return!0===n&&ce.elements.sort(ge),ce}};