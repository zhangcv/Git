THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var T,g,S,H,w,C,M,b,L,B,P,V,W,z,j,k,D,F,N,O=this,A=new THREE.Projector,o=void 0!==e.canvas?e.canvas:document.createElement("canvas"),I=o.width,G=o.height,U=Math.floor(I/2),q=Math.floor(G/2),J=0,K=0,Q=I,X=G,n=1,Y=o.getContext("2d",{alpha:!0===e.alpha}),i=new THREE.Color(0),r=!0===e.alpha?0:1,a=1,s=0,l=null,c=null,p=null,E=null,f=null,t=[],Z=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),$=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),_=new THREE.Color,ee=new THREE.Color,te={},ie=new THREE.Box2,oe=new THREE.Box2,ne=new THREE.Box2,re=new THREE.Color,ae=new THREE.Color,se=new THREE.Color,le=new THREE.Vector3,ce=new THREE.Vector3,pe=new THREE.Vector3,Ee=new THREE.Matrix3;function fe(e,t,i){Re(i.opacity),ue(i.blending);var o=t.scale.x*U,n=t.scale.y*q,r=.5*Math.sqrt(o*o+n*n);if(ne.min.set(e.x-r,e.y-r),ne.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial){var a=i.map;if(null!==a){var s=te[a.id];if(void 0!==s&&s.version===a.version||(s=ve(a),te[a.id]=s),void 0!==s.canvas){Te(s.canvas);var l=a.image,c=l.width*a.offset.x,p=l.height*a.offset.y,E=l.width*a.repeat.x,f=l.height*a.repeat.y,d=o/E,h=n/f;Y.save(),Y.translate(e.x,e.y),0!==i.rotation&&Y.rotate(i.rotation),Y.translate(-o/2,-n/2),Y.scale(d,h),Y.translate(-c,-p),Y.fillRect(c,p,E,f),Y.restore()}}else Te(i.color.getStyle()),Y.save(),Y.translate(e.x,e.y),0!==i.rotation&&Y.rotate(i.rotation),Y.scale(o,-n),Y.fillRect(-.5,-.5,1,1),Y.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(v(i.color.getStyle()),Te(i.color.getStyle()),Y.save(),Y.translate(e.x,e.y),0!==i.rotation&&Y.rotate(i.rotation),Y.scale(o,n),i.program(Y),Y.restore())}function de(e,t,i,o){if(Re(o.opacity),ue(o.blending),Y.beginPath(),Y.moveTo(e.positionScreen.x,e.positionScreen.y),Y.lineTo(t.positionScreen.x,t.positionScreen.y),o instanceof THREE.LineBasicMaterial){if(d(o.linewidth),h(o.linecap),m(o.linejoin),o.vertexColors!==THREE.VertexColors)v(o.color.getStyle());else{var n=i.vertexColors[0].getStyle(),r=i.vertexColors[1].getStyle();if(n===r)v(n);else{try{var a=Y.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,n),a.addColorStop(1,r)}catch(e){a=n}v(a)}}Y.stroke(),ne.expandByScalar(2*o.linewidth)}else o instanceof THREE.LineDashedMaterial&&(d(o.linewidth),h(o.linecap),m(o.linejoin),v(o.color.getStyle()),x([o.dashSize,o.gapSize]),Y.stroke(),ne.expandByScalar(2*o.linewidth),x([]))}function he(e,t,i,o){d(t),h(i),m(o),v(e.getStyle()),Y.stroke(),ne.expandByScalar(2*t)}function me(e){Te(e.getStyle()),Y.fill()}function ve(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,o=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,n=e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(n?2:1),a.height=t.height*(r?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),1==n&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),1==r&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),1==n&&1==r&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";1==i&&1==o?l="repeat":1==i?l="repeat-x":1==o&&(l="repeat-y");var c=Y.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function xe(e,t,i,o,n,r,a,s,l,c,p,E,f){var d=te[f.id];if(void 0!==d&&d.version===f.version||(d=ve(f),te[f.id]=d),void 0===d.canvas)return Te("rgba( 0, 0, 0, 1)"),void Y.fill();Te(d.canvas);var h,m,v,x,y,R,u,T,g=f.offset.x/f.repeat.x,S=f.offset.y/f.repeat.y,H=f.image.width*f.repeat.x,w=f.image.height*f.repeat.y;l=(l+g)*H,c=(c+S)*w,p=(p+g)*H,E=(E+S)*w,i-=e,o-=t,n-=e,r-=t,0!=(u=(l-=a=(a+g)*H)*(E-=s=(s+S)*w)-(p-=a)*(c-=s))&&(y=e-(h=(E*i-c*n)*(T=1/u))*a-(v=(l*n-p*i)*T)*s,R=t-(m=(E*o-c*r)*T)*a-(x=(l*r-p*o)*T)*s,Y.save(),Y.transform(h,m,v,x,y,R),Y.fill(),Y.restore())}function ye(e,t,i){var o,n=t.x-e.x,r=t.y-e.y,a=n*n+r*r;0!=a&&(n*=o=i/Math.sqrt(a),r*=o,t.x+=n,t.y+=r,e.x-=n,e.y-=r)}function Re(e){a!==e&&(Y.globalAlpha=e,a=e)}function ue(e){s!==e&&(e===THREE.NormalBlending?Y.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?Y.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?Y.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(Y.globalCompositeOperation="multiply"),s=e)}function d(e){p!==e&&(Y.lineWidth=e,p=e)}function h(e){E!==e&&(Y.lineCap=e,E=e)}function m(e){f!==e&&(Y.lineJoin=e,f=e)}function v(e){l!==e&&(Y.strokeStyle=e,l=e)}function Te(e){c!==e&&(Y.fillStyle=e,c=e)}function x(e){t.length!==e.length&&(Y.setLineDash(e),t=e)}void 0===Y.setLineDash&&(Y.setLineDash=function(){}),this.domElement=o,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return Y},this.getContextAttributes=function(){return Y.getContextAttributes()},this.getPixelRatio=function(){return n},this.setPixelRatio=function(e){void 0!==e&&(n=e)},this.setSize=function(e,t,i){I=e*n,G=t*n,o.width=I,o.height=G,U=Math.floor(I/2),q=Math.floor(G/2),!1!==i&&(o.style.width=e+"px",o.style.height=t+"px"),ie.min.set(-U,-q),ie.max.set(U,q),oe.min.set(-U,-q),oe.max.set(U,q),a=1,s=0,f=E=p=c=l=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,o){J=e*n,K=t*n,Q=i*n,X=o*n},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1,oe.min.set(-U,-q),oe.max.set(U,q)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return i},this.getClearAlpha=function(){return r},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===oe.isEmpty()&&(oe.intersect(ie),oe.expandByScalar(2),oe.min.x=oe.min.x+U,oe.min.y=-oe.min.y+q,oe.max.x=oe.max.x+U,oe.max.y=-oe.max.y+q,r<1&&Y.clearRect(0|oe.min.x,0|oe.max.y,oe.max.x-oe.min.x|0,oe.min.y-oe.max.y|0),0<r&&(ue(THREE.NormalBlending),Re(1),Te("rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"),Y.fillRect(0|oe.min.x,0|oe.max.y,oe.max.x-oe.min.x|0,oe.min.y-oe.max.y|0)),oe.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof THREE.Camera!=0){var i=e.background;i&&i.isColor?(Te("rgb("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+")"),Y.fillRect(0,0,I,G)):!0===this.autoClear&&this.clear(),O.info.render.vertices=0,O.info.render.faces=0,Y.setTransform(Q/I,0,0,-X/G,J,G-K),Y.translate(U,q),T=A.projectScene(e,t,this.sortObjects,this.sortElements),g=T.elements,S=T.lights,Ee.getNormalMatrix(t.matrixWorldInverse),function(){re.setRGB(0,0,0),ae.setRGB(0,0,0),se.setRGB(0,0,0);for(var e=0,t=S.length;e<t;e++){var i=S[e],o=i.color;i instanceof THREE.AmbientLight?re.add(o):i instanceof THREE.DirectionalLight?ae.add(o):i instanceof THREE.PointLight&&se.add(o)}}();for(var o=0,n=g.length;o<n;o++){var r=g[o],a=r.material;if(void 0!==a&&0!==a.opacity){if(ne.makeEmpty(),r instanceof THREE.RenderableSprite)(H=r).x*=U,H.y*=q,fe(H,r,a);else if(r instanceof THREE.RenderableLine)H=r.v1,w=r.v2,H.positionScreen.x*=U,H.positionScreen.y*=q,w.positionScreen.x*=U,w.positionScreen.y*=q,ne.setFromPoints([H.positionScreen,w.positionScreen]),!0===ie.intersectsBox(ne)&&de(H,w,r,a);else if(r instanceof THREE.RenderableFace){if(H=r.v1,w=r.v2,C=r.v3,H.positionScreen.z<-1||1<H.positionScreen.z)continue;if(w.positionScreen.z<-1||1<w.positionScreen.z)continue;if(C.positionScreen.z<-1||1<C.positionScreen.z)continue;H.positionScreen.x*=U,H.positionScreen.y*=q,w.positionScreen.x*=U,w.positionScreen.y*=q,C.positionScreen.x*=U,C.positionScreen.y*=q,0<a.overdraw&&(ye(H.positionScreen,w.positionScreen,a.overdraw),ye(w.positionScreen,C.positionScreen,a.overdraw),ye(C.positionScreen,H.positionScreen,a.overdraw)),ne.setFromPoints([H.positionScreen,w.positionScreen,C.positionScreen]),!0===ie.intersectsBox(ne)&&(s=H,l=w,c=C,E=1,f=2,d=r,h=a,u=R=y=x=v=m=void(p=0),O.info.render.vertices+=3,O.info.render.faces++,Re(h.opacity),ue(h.blending),M=s.positionScreen.x,b=s.positionScreen.y,L=l.positionScreen.x,B=l.positionScreen.y,P=c.positionScreen.x,V=c.positionScreen.y,m=M,v=b,x=L,y=B,R=P,u=V,Y.beginPath(),Y.moveTo(m,v),Y.lineTo(x,y),Y.lineTo(R,u),Y.closePath(),(h instanceof THREE.MeshLambertMaterial||h instanceof THREE.MeshPhongMaterial)&&null===h.map?($.copy(h.color),_.copy(h.emissive),h.vertexColors===THREE.FaceColors&&$.multiply(d.color),Z.copy(re),ce.copy(s.positionWorld).add(l.positionWorld).add(c.positionWorld).divideScalar(3),function(e,t,i){for(var o=0,n=S.length;o<n;o++){var r=S[o];if(ee.copy(r.color),r instanceof THREE.DirectionalLight){var a=le.setFromMatrixPosition(r.matrixWorld).normalize();if((s=t.dot(a))<=0)continue;s*=r.intensity,i.add(ee.multiplyScalar(s))}else if(r instanceof THREE.PointLight){var s;if(a=le.setFromMatrixPosition(r.matrixWorld),(s=t.dot(le.subVectors(a,e).normalize()))<=0)continue;if(0==(s*=0==r.distance?1:1-Math.min(e.distanceTo(a)/r.distance,1)))continue;s*=r.intensity,i.add(ee.multiplyScalar(s))}}}(ce,d.normalModel,Z),Z.multiply($).add(_),!0===h.wireframe?he(Z,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):me(Z)):h instanceof THREE.MeshBasicMaterial||h instanceof THREE.MeshLambertMaterial||h instanceof THREE.MeshPhongMaterial?null!==h.map?h.map.mapping===THREE.UVMapping&&(W=d.uvs,xe(M,b,L,B,P,V,W[p].x,W[p].y,W[E].x,W[E].y,W[f].x,W[f].y,h.map)):null!==h.envMap?h.envMap.mapping===THREE.SphericalReflectionMapping&&(pe.copy(d.vertexNormalsModel[p]).applyMatrix3(Ee),z=.5*pe.x+.5,j=.5*pe.y+.5,pe.copy(d.vertexNormalsModel[E]).applyMatrix3(Ee),k=.5*pe.x+.5,D=.5*pe.y+.5,pe.copy(d.vertexNormalsModel[f]).applyMatrix3(Ee),F=.5*pe.x+.5,N=.5*pe.y+.5,xe(M,b,L,B,P,V,z,j,k,D,F,N,h.envMap)):(Z.copy(h.color),h.vertexColors===THREE.FaceColors&&Z.multiply(d.color),!0===h.wireframe?he(Z,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):me(Z)):(h instanceof THREE.MeshNormalMaterial?(pe.copy(d.normalModel).applyMatrix3(Ee),Z.setRGB(pe.x,pe.y,pe.z).multiplyScalar(.5).addScalar(.5)):Z.setRGB(1,1,1),!0===h.wireframe?he(Z,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):me(Z)))}oe.union(ne)}}Y.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");var s,l,c,p,E,f,d,h,m,v,x,y,R,u}};