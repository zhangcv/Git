THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var y,R,u,T,g,S,H,w,C,M,b,L,B,P,V,W,z,j,k,D=this,F=new THREE.Projector,n=void 0!==e.canvas?e.canvas:document.createElement("canvas"),N=n.width,O=n.height,A=Math.floor(N/2),I=Math.floor(O/2),G=0,U=0,q=N,J=O,o=1,K=n.getContext("2d",{alpha:!0===e.alpha}),i=new THREE.Color(0),r=!0===e.alpha?0:1,a=1,s=0,l=null,c=null,p=null,E=null,f=null,t=[],Q=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),X=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),Y=new THREE.Color,Z=new THREE.Color,$={},_=new THREE.Box2,ee=new THREE.Box2,te=new THREE.Box2,ie=new THREE.Color,ne=new THREE.Color,oe=new THREE.Color,re=new THREE.Vector3,ae=new THREE.Vector3,se=new THREE.Vector3,le=new THREE.Matrix3;function ce(e,t,i){ve(i.opacity),xe(i.blending);var n=t.scale.x*A,o=t.scale.y*I,r=.5*Math.sqrt(n*n+o*o);if(te.min.set(e.x-r,e.y-r),te.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial){var a=i.map;if(null!==a){var s=$[a.id];if(void 0!==s&&s.version===a.version||(s=de(a),$[a.id]=s),void 0!==s.canvas){ye(s.canvas);var l=a.image,c=l.width*a.offset.x,p=l.height*a.offset.y,E=l.width*a.repeat.x,f=l.height*a.repeat.y,d=n/E,h=o/f;K.save(),K.translate(e.x,e.y),0!==i.rotation&&K.rotate(i.rotation),K.translate(-n/2,-o/2),K.scale(d,h),K.translate(-c,-p),K.fillRect(c,p,E,f),K.restore()}}else ye(i.color.getStyle()),K.save(),K.translate(e.x,e.y),0!==i.rotation&&K.rotate(i.rotation),K.scale(n,-o),K.fillRect(-.5,-.5,1,1),K.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(v(i.color.getStyle()),ye(i.color.getStyle()),K.save(),K.translate(e.x,e.y),0!==i.rotation&&K.rotate(i.rotation),K.scale(n,o),i.program(K),K.restore())}function pe(e,t,i,n){if(ve(n.opacity),xe(n.blending),K.beginPath(),K.moveTo(e.positionScreen.x,e.positionScreen.y),K.lineTo(t.positionScreen.x,t.positionScreen.y),n instanceof THREE.LineBasicMaterial){if(d(n.linewidth),h(n.linecap),m(n.linejoin),n.vertexColors!==THREE.VertexColors)v(n.color.getStyle());else{var o=i.vertexColors[0].getStyle(),r=i.vertexColors[1].getStyle();if(o===r)v(o);else{try{var a=K.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,r)}catch(e){a=o}v(a)}}K.stroke(),te.expandByScalar(2*n.linewidth)}else n instanceof THREE.LineDashedMaterial&&(d(n.linewidth),h(n.linecap),m(n.linejoin),v(n.color.getStyle()),x([n.dashSize,n.gapSize]),K.stroke(),te.expandByScalar(2*n.linewidth),x([]))}function Ee(e,t,i,n){d(t),h(i),m(n),v(e.getStyle()),K.stroke(),te.expandByScalar(2*t)}function fe(e){ye(e.getStyle()),K.fill()}function de(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,n=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,o=e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(o?2:1),a.height=t.height*(r?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),1==o&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),1==r&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),1==o&&1==r&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";1==i&&1==n?l="repeat":1==i?l="repeat-x":1==n&&(l="repeat-y");var c=K.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function he(e,t,i,n,o,r,a,s,l,c,p,E,f){var d=$[f.id];if(void 0!==d&&d.version===f.version||(d=de(f),$[f.id]=d),void 0===d.canvas)return ye("rgba( 0, 0, 0, 1)"),void K.fill();ye(d.canvas);var h,m,v,x,y,R,u,T,g=f.offset.x/f.repeat.x,S=f.offset.y/f.repeat.y,H=f.image.width*f.repeat.x,w=f.image.height*f.repeat.y;l=(l+g)*H,c=(c+S)*w,p=(p+g)*H,E=(E+S)*w,i-=e,n-=t,o-=e,r-=t,0!=(u=(l-=a=(a+g)*H)*(E-=s=(s+S)*w)-(p-=a)*(c-=s))&&(y=e-(h=(E*i-c*o)*(T=1/u))*a-(v=(l*o-p*i)*T)*s,R=t-(m=(E*n-c*r)*T)*a-(x=(l*r-p*n)*T)*s,K.save(),K.transform(h,m,v,x,y,R),K.fill(),K.restore())}function me(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!=a&&(o*=n=i/Math.sqrt(a),r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function ve(e){a!==e&&(K.globalAlpha=e,a=e)}function xe(e){s!==e&&(e===THREE.NormalBlending?K.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?K.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?K.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(K.globalCompositeOperation="multiply"),s=e)}function d(e){p!==e&&(K.lineWidth=e,p=e)}function h(e){E!==e&&(K.lineCap=e,E=e)}function m(e){f!==e&&(K.lineJoin=e,f=e)}function v(e){l!==e&&(K.strokeStyle=e,l=e)}function ye(e){c!==e&&(K.fillStyle=e,c=e)}function x(e){t.length!==e.length&&(K.setLineDash(e),t=e)}void 0===K.setLineDash&&(K.setLineDash=function(){}),this.domElement=n,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return K},this.getContextAttributes=function(){return K.getContextAttributes()},this.getPixelRatio=function(){return o},this.setPixelRatio=function(e){void 0!==e&&(o=e)},this.setSize=function(e,t,i){N=e*o,O=t*o,n.width=N,n.height=O,A=Math.floor(N/2),I=Math.floor(O/2),!1!==i&&(n.style.width=e+"px",n.style.height=t+"px"),_.min.set(-A,-I),_.max.set(A,I),ee.min.set(-A,-I),ee.max.set(A,I),a=1,s=0,f=E=p=c=l=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){G=e*o,U=t*o,q=i*o,J=n*o},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1,ee.min.set(-A,-I),ee.max.set(A,I)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return i},this.getClearAlpha=function(){return r},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===ee.isEmpty()&&(ee.intersect(_),ee.expandByScalar(2),ee.min.x=ee.min.x+A,ee.min.y=-ee.min.y+I,ee.max.x=ee.max.x+A,ee.max.y=-ee.max.y+I,r<1&&K.clearRect(0|ee.min.x,0|ee.max.y,ee.max.x-ee.min.x|0,ee.min.y-ee.max.y|0),0<r&&(xe(THREE.NormalBlending),ve(1),ye("rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"),K.fillRect(0|ee.min.x,0|ee.max.y,ee.max.x-ee.min.x|0,ee.min.y-ee.max.y|0)),ee.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof THREE.Camera!=0){var i=e.background;i&&i.isColor?(ye("rgb("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+")"),K.fillRect(0,0,N,O)):!0===this.autoClear&&this.clear(),D.info.render.vertices=0,D.info.render.faces=0,K.setTransform(q/N,0,0,-J/O,G,O-U),K.translate(A,I),y=F.projectScene(e,t,this.sortObjects,this.sortElements),R=y.elements,u=y.lights,le.getNormalMatrix(t.matrixWorldInverse),function(){ie.setRGB(0,0,0),ne.setRGB(0,0,0),oe.setRGB(0,0,0);for(var e=0,t=u.length;e<t;e++){var i=u[e],n=i.color;i instanceof THREE.AmbientLight?ie.add(n):i instanceof THREE.DirectionalLight?ne.add(n):i instanceof THREE.PointLight&&oe.add(n)}}();for(var n=0,o=R.length;n<o;n++){var r=R[n],a=r.material;if(void 0!==a&&0!==a.opacity){if(te.makeEmpty(),r instanceof THREE.RenderableSprite)(T=r).x*=A,T.y*=I,ce(T,r,a);else if(r instanceof THREE.RenderableLine)T=r.v1,g=r.v2,T.positionScreen.x*=A,T.positionScreen.y*=I,g.positionScreen.x*=A,g.positionScreen.y*=I,te.setFromPoints([T.positionScreen,g.positionScreen]),!0===_.intersectsBox(te)&&pe(T,g,r,a);else if(r instanceof THREE.RenderableFace){if(T=r.v1,g=r.v2,S=r.v3,T.positionScreen.z<-1||1<T.positionScreen.z)continue;if(g.positionScreen.z<-1||1<g.positionScreen.z)continue;if(S.positionScreen.z<-1||1<S.positionScreen.z)continue;T.positionScreen.x*=A,T.positionScreen.y*=I,g.positionScreen.x*=A,g.positionScreen.y*=I,S.positionScreen.x*=A,S.positionScreen.y*=I,0<a.overdraw&&(me(T.positionScreen,g.positionScreen,a.overdraw),me(g.positionScreen,S.positionScreen,a.overdraw),me(S.positionScreen,T.positionScreen,a.overdraw)),te.setFromPoints([T.positionScreen,g.positionScreen,S.positionScreen]),!0===_.intersectsBox(te)&&(s=T,l=g,c=S,p=r,E=a,D.info.render.vertices+=3,D.info.render.faces++,ve(E.opacity),xe(E.blending),H=s.positionScreen.x,w=s.positionScreen.y,C=l.positionScreen.x,M=l.positionScreen.y,b=c.positionScreen.x,L=c.positionScreen.y,f=H,d=w,h=C,m=M,v=b,x=L,K.beginPath(),K.moveTo(f,d),K.lineTo(h,m),K.lineTo(v,x),K.closePath(),(E instanceof THREE.MeshLambertMaterial||E instanceof THREE.MeshPhongMaterial)&&null===E.map?(X.copy(E.color),Y.copy(E.emissive),E.vertexColors===THREE.FaceColors&&X.multiply(p.color),Q.copy(ie),ae.copy(s.positionWorld).add(l.positionWorld).add(c.positionWorld).divideScalar(3),function(e,t,i){for(var n=0,o=u.length;n<o;n++){var r=u[n];if(Z.copy(r.color),r instanceof THREE.DirectionalLight){var a=re.setFromMatrixPosition(r.matrixWorld).normalize();if((s=t.dot(a))<=0)continue;s*=r.intensity,i.add(Z.multiplyScalar(s))}else if(r instanceof THREE.PointLight){var s;if(a=re.setFromMatrixPosition(r.matrixWorld),(s=t.dot(re.subVectors(a,e).normalize()))<=0)continue;if(0==(s*=0==r.distance?1:1-Math.min(e.distanceTo(a)/r.distance,1)))continue;s*=r.intensity,i.add(Z.multiplyScalar(s))}}}(ae,p.normalModel,Q),Q.multiply(X).add(Y),!0===E.wireframe?Ee(Q,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):fe(Q)):E instanceof THREE.MeshBasicMaterial||E instanceof THREE.MeshLambertMaterial||E instanceof THREE.MeshPhongMaterial?null!==E.map?E.map.mapping===THREE.UVMapping&&(B=p.uvs,he(H,w,C,M,b,L,B[0].x,B[0].y,B[1].x,B[1].y,B[2].x,B[2].y,E.map)):null!==E.envMap?E.envMap.mapping===THREE.SphericalReflectionMapping&&(se.copy(p.vertexNormalsModel[0]).applyMatrix3(le),P=.5*se.x+.5,V=.5*se.y+.5,se.copy(p.vertexNormalsModel[1]).applyMatrix3(le),W=.5*se.x+.5,z=.5*se.y+.5,se.copy(p.vertexNormalsModel[2]).applyMatrix3(le),j=.5*se.x+.5,k=.5*se.y+.5,he(H,w,C,M,b,L,P,V,W,z,j,k,E.envMap)):(Q.copy(E.color),E.vertexColors===THREE.FaceColors&&Q.multiply(p.color),!0===E.wireframe?Ee(Q,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):fe(Q)):(E instanceof THREE.MeshNormalMaterial?(se.copy(p.normalModel).applyMatrix3(le),Q.setRGB(se.x,se.y,se.z).multiplyScalar(.5).addScalar(.5)):Q.setRGB(1,1,1),!0===E.wireframe?Ee(Q,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):fe(Q)))}ee.union(te)}}K.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");var s,l,c,p,E,f,d,h,m,v,x}};